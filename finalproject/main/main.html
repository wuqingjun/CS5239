<!doctype html>
<html>
	<head>
		<title>Frozen</title>
		<link rel="stylesheet" type="text/css" href="style.css" />
        <script type="text/javascript" src="libs/three.js"></script>
	    <script type="text/javascript" src="libs/dat.gui.min.js"></script>
        <script type="text/javascript" src="libs/OBJLoader.js"></script>
	</head>
	<body>
		<script type="x-shader/x-vertex" id="main_vs">
			uniform float radiusX;
			uniform float radiusZ;
			uniform float size;
			uniform float scale;
			uniform float height;
			uniform float elapsedTime;
			uniform float speedH;
			uniform float speedV;

			void main() {
				vec3 pos = position;
				pos.x += cos((elapsedTime + position.z) * 0.25 * speedH) * radiusX;
				pos.y = mod(pos.y - elapsedTime * speedV, height);
				pos.z += sin((elapsedTime + position.x) * 0.25 * speedH) * radiusZ;

				vec4 mvPosition = modelViewMatrix * vec4( pos, 1.0 );

				gl_PointSize = size * ( scale / length( mvPosition.xyz ) );

				gl_Position = projectionMatrix * mvPosition;
			}
		</script>

	<script type="x-shader/x-fragment" id="main_fs">
			uniform vec3 color;
			uniform float opacity;
			uniform sampler2D texture;

			void main() {
				vec4 texColor = texture2D( texture, gl_PointCoord );
				gl_FragColor = texColor * vec4( color, opacity );
			}
		</script>
	<script>
        window.onload = function () {
            var renderer,
                scene,
                camera,
                cameraRadius = 50.0,
                cameraTarget,
                cameraX = 0,
                cameraY = 0,
                cameraZ = cameraRadius,
                particleSystem,
                particleSystemHeight = 100.0,
                clock,
                controls,
                parameters,
                onParametersUpdate,
                textureSnow,
                textureElsa;

            init();
            animate();


            function init() {

                renderer = new THREE.WebGLRenderer();

                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setClearColor(new THREE.Color(0x000000));

                scene = new THREE.Scene();

                camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 10000);
                cameraTarget = new THREE.Vector3(0, 0, 0);

                var ambient = new THREE.AmbientLight(0x101030);
                scene.add(ambient);

                var directionalLight = new THREE.DirectionalLight(0xffeedd);
                directionalLight.position.set(0, 0, 1);
                scene.add(directionalLight);

                textureSnow = THREE.ImageUtils.loadTexture('snowflake1.png');

                var numParticles = 10000,
                    width = 100,
                    height = particleSystemHeight,
                    depth = 100,
                    parameters = {
                        color: 0xFFFFFF,
                        height: particleSystemHeight,
                        radiusX: 2.5,
                        radiusZ: 2.5,
                        size: 100,
                        scale: 4.0,
                        opacity: 0.4,
                        speedH: 1.0,
                        speedV: 1.0
                    },
                    systemGeometry = new THREE.Geometry(),
                    systemMaterial = new THREE.ShaderMaterial({
                        uniforms: {
                            color: { type: 'c', value: new THREE.Color(parameters.color) },
                            height: { type: 'f', value: parameters.height },
                            elapsedTime: { type: 'f', value: 0 },
                            radiusX: { type: 'f', value: parameters.radiusX },
                            radiusZ: { type: 'f', value: parameters.radiusZ },
                            size: { type: 'f', value: parameters.size },
                            scale: { type: 'f', value: parameters.scale },
                            opacity: { type: 'f', value: parameters.opacity },
                            texture: { type: 't', value: textureSnow },
                            speedH: { type: 'f', value: parameters.speedH },
                            speedV: { type: 'f', value: parameters.speedV }
                        },
                        vertexShader: document.getElementById('main_vs').textContent,
                        fragmentShader: document.getElementById('main_fs').textContent,
                        blending: THREE.AdditiveBlending,
                        transparent: true,
                        depthTest: false
                    });

                for (var i = 0; i < numParticles; i++) {
                    var vertex = new THREE.Vector3(
                            rand(width),
                            Math.random() * height,
                            rand(depth)
                        );

                    systemGeometry.vertices.push(vertex);
                }

                particleSystem = new THREE.ParticleSystem(systemGeometry, systemMaterial);
                particleSystem.position.y = -height / 2;

                scene.add(particleSystem);


                // adding Elsa
                var manager = new THREE.LoadingManager();
                manager.onProgress = function (item, loaded, total) {

                    console.log(item, loaded, total);

                };

                textureElsa = new THREE.Texture();

                var onProgress = function (xhr) {
                    if (xhr.lengthComputable) {
                        var percentComplete = xhr.loaded / xhr.total * 100;
                        console.log(Math.round(percentComplete, 2) + '% downloaded');
                    }
                };

                var onError = function (xhr) {
                    console.log("error happening");
                };


                var imageLoader = new THREE.ImageLoader(manager);
                imageLoader.load('ObjectSurface_Color.png', function (image) {

                    textureElsa.image = image;
                    textureElsa.needsUpdate = true;

                });

                // model

                var loader = new THREE.OBJLoader(manager);
                loader.load('Elsa2.obj', function (object) {

                    object.traverse(function (child) {

                        if (child instanceof THREE.Mesh) {

                            child.material.map = textureElsa;

                        }

                    });

                    object.position.y = -30;
                    object.position.x = 10;
                    object.scale.set(10, 10, 10);
                    scene.add(object);

                }, onProgress, onError);


                clock = new THREE.Clock();

                document.body.appendChild(renderer.domElement);

                onParametersUpdate = function (v) {
                    systemMaterial.uniforms.color.value.set(parameters.color);
                    systemMaterial.uniforms.height.value = parameters.height;
                    systemMaterial.uniforms.radiusX.value = parameters.radiusX;
                    systemMaterial.uniforms.radiusZ.value = parameters.radiusZ;
                    systemMaterial.uniforms.size.value = parameters.size;
                    systemMaterial.uniforms.scale.value = parameters.scale;
                    systemMaterial.uniforms.opacity.value = parameters.opacity;
                    systemMaterial.uniforms.speedH.value = parameters.speedH;
                    systemMaterial.uniforms.speedV.value = parameters.speedV;
                }

                controls = new dat.GUI();
                controls.close();

                controls.addColor(parameters, 'color').onChange(onParametersUpdate);
                controls.add(parameters, 'height', 0, particleSystemHeight * 2.0).onChange(onParametersUpdate);
                controls.add(parameters, 'radiusX', 0, 10).onChange(onParametersUpdate);
                controls.add(parameters, 'radiusZ', 0, 10).onChange(onParametersUpdate);
                controls.add(parameters, 'size', 1, 400).onChange(onParametersUpdate);
                controls.add(parameters, 'scale', 1, 30).onChange(onParametersUpdate);
                controls.add(parameters, 'opacity', 0, 1).onChange(onParametersUpdate);
                controls.add(parameters, 'speedH', 0.1, 3).onChange(onParametersUpdate);
                controls.add(parameters, 'speedV', 0.1, 3).onChange(onParametersUpdate);

                document.addEventListener('mousemove', function (e) {
                    var mouseX = e.clientX,
                        mouseY = e.clientY,
                        width = window.innerWidth,
                        halfWidth = width >> 1,
                        height = window.innerHeight,
                        halfHeight = height >> 1;

                    cameraX = cameraRadius * (mouseX - halfWidth) / halfWidth;
                    cameraY = cameraRadius * (mouseY - halfHeight) / halfHeight;
                }, false);

                document.addEventListener('mousewheel', onMouseWheel, false);
                document.addEventListener('DOMMouseScroll', onMouseWheel, false);

            }

            function onMouseWheel(e) {
                e.preventDefault();

                if (e.wheelDelta) {
                    cameraZ += e.wheelDelta * 0.05;
                } else if (e.detail) {
                    cameraZ += e.detail * 0.5;
                }
            }

            function rand(v) {
                return (v * (Math.random() - 0.5));
            }


            function animate() {

                requestAnimationFrame(animate);

                var delta = clock.getDelta(),
                    elapsedTime = clock.getElapsedTime();

                particleSystem.material.uniforms.elapsedTime.value = elapsedTime * 10;

                camera.position.set(cameraX, cameraY, cameraZ);
                camera.lookAt(cameraTarget);

                renderer.clear();
                renderer.render(scene, camera);

            }
        }

	</script>

	</body>
</html>
